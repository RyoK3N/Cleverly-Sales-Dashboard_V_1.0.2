
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cleverly Sales Dashboard - Cold Email</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
    <style>
        .navbar {
            margin-bottom: 2rem;
        }
        .stats-container {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .filters-container {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }
        .table-container {
            background: white;
            padding: 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        .highlighted-row {
            background-color: #fff3cd !important;
            transition: background-color 0.3s;
        }
        .highlighted-row:hover {
            background-color: #ffe69c !important;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .alert {
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">Cleverly Sales Dashboard</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/chatbot">Chatbot</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/predictions">Predictions</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="/data">Cold-Email <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                         <a class="nav-link" href="/logout">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1>Cold-Email Performance Dashboard</h1>
                <p class="lead">Track and analyze your cold-email campaigns performance metrics</p>
            </div>
        </div>

        <div class="filters-container">
            <h5>Filters</h5>
            <form id="filter-form">
                <div class="form-row">
                    <div class="form-group col-md-3">
                        <label for="start_date">Start Date:</label>
                        <input type="date" id="start_date" name="start_date" class="form-control">
                    </div>
                    <div class="form-group col-md-3">
                        <label for="end_date">End Date:</label>
                        <input type="date" id="end_date" name="end_date" class="form-control">
                    </div>
                    <div class="form-group col-md-3">
                        <label for="filter_column">Filter Column:</label>
                        <select id="filter_column" name="filter_column" class="form-control">
                            <option value="Date Created">Date Created</option>
                            <option value="Sales Call Date">Sales Call Date</option>
                        </select>
                    </div>
                    <div class="form-group col-md-3">
                        <label for="selected_owners">Select Owners:</label>
                        <select id="selected_owners" name="selected_owners" class="form-control" multiple>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Apply Filters</button>
            </form>
        </div>

        <div id="alert-container"></div>
        <div id="loader" class="loader" style="display: none;"></div>

        <div class="stats-container" id="stats-container" style="display: none;">
            <h5>Quick Stats (Cold-Email Only)</h5>
            <div class="row" id="stats-row">
                <!-- Stats will be populated here -->
            </div>
        </div>

        <div class="table-container">
            <h5>Results</h5>
            <div class="form-group">
                <label for="owner-filter">Select Owners to Display:</label>
                <div id="owner-checkboxes" class="mb-3">
                    <!-- Owner checkboxes will be populated here -->
                </div>
                <button type="button" class="btn btn-primary" id="apply-owner-filter">Apply Owner Filter</button>
            </div>
            
            <div id="results-message" class="alert alert-success" style="display: none;">
                Data processed successfully!
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-bordered" id="results-table">
                    <thead>
                        <tr>
                            <th>No data loaded. Please apply filters to see results.</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Populate owners dropdown
        function populateOwners() {
            $.get('/get_owners', function(data) {
                const ownersSelect = $('#selected_owners');
                ownersSelect.empty();
                data.owners.forEach(owner => {
                    ownersSelect.append(new Option(owner, owner));
                });
            });
        }

        // Set default dates
        const end_date = new Date('2025-12-31');
        const start_date = new Date('2024-01-01');
        $('#start_date').val(start_date.toISOString().split('T')[0]);
        $('#end_date').val(end_date.toISOString().split('T')[0]);
        
        // Populate owners on page load
        $(document).ready(function() {
            populateOwners();
        });

        // Handle filter form submission
        $('#filter-form').submit(function(e) {
            e.preventDefault();
            $('#loader').show();
            $('#alert-container').empty();
            
            const formData = {
                start_date: $('#start_date').val(),
                end_date: $('#end_date').val(),
                filter_column: $('#filter_column').val(),
                selected_owners: $('#selected_owners').val() || []
            };

            $.ajax({
                url: '/apply_filters_cold_email',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    $('#loader').hide();
                    if(response.status === 'success') {
                        $('#results-table').html(response.table);
                        $('#results-message').show();
                        $('#stats-container').show();
                        generateStats();
                        populateOwnerCheckboxes();
                        
                        setTimeout(function() {
                            $('#results-message').fadeOut();
                        }, 3000);
                    } else {
                        $('#alert-container').html(`
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                Error: ${response.message}
                                <button type="button" class="close" data-dismiss="alert">
                                    <span>&times;</span>
                                </button>
                            </div>
                        `);
                    }
                },
                error: function(xhr, status, error) {
                    $('#loader').hide();
                    $('#alert-container').html(`
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            Error applying filters: ${error}
                            <button type="button" class="close" data-dismiss="alert">
                                <span>&times;</span>
                            </button>
                        </div>
                    `);
                }
            });
        });

        // Generate quick stats from table data
        function generateStats() {
            const table = $('#results-table table');
            if (table.length === 0) return;

            const rows = table.find('tbody tr');
            let totalCalls = 0;
            let totalRevenue = 0;
            let totalColdEmails = 0;

            rows.each(function() {
                const cells = $(this).find('td');
                if (cells.length > 0) {
                    const owner = cells.eq(0).text().trim();
                    if (owner !== 'Total') {
                        // Assuming columns: Owner, New Calls Booked, ..., Cold Emails, ...
                        const callsText = cells.eq(1).text().trim();
                        const calls = parseInt(callsText) || 0;
                        totalCalls += calls;

                        // Find Cold Emails column (assuming it's one of the later columns)
                        cells.each(function(index) {
                            const headerCell = table.find('thead tr th').eq(index);
                            if (headerCell.text().includes('Cold Emails')) {
                                const coldEmailsText = $(this).text().trim();
                                const coldEmails = parseInt(coldEmailsText) || 0;
                                totalColdEmails += coldEmails;
                            }
                            if (headerCell.text().includes('Closed Revenue')) {
                                const revenueText = $(this).text().trim();
                                const revenue = parseFloat(revenueText) || 0;
                                totalRevenue += revenue;
                            }
                        });
                    }
                }
            });

            const statsHtml = `
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-value">${totalColdEmails}</div>
                        <div class="stat-label">Total Cold Emails</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-value">${totalCalls}</div>
                        <div class="stat-label">Total Calls Booked</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-value">$${totalRevenue.toLocaleString()}</div>
                        <div class="stat-label">Total Revenue</div>
                    </div>
                </div>
            `;
            $('#stats-row').html(statsHtml);
        }

        // Populate owner checkboxes for filtering
        function populateOwnerCheckboxes() {
            const table = $('#results-table table');
            if (table.length === 0) return;

            const owners = [];
            table.find('tbody tr').each(function() {
                const ownerCell = $(this).find('td:first');
                if (ownerCell.length > 0) {
                    const owner = ownerCell.text().trim();
                    if (owner && owner !== 'Total' && !owners.includes(owner)) {
                        owners.push(owner);
                    }
                }
            });

            let checkboxHtml = '';
            owners.forEach(owner => {
                checkboxHtml += `
                    <div class="form-check form-check-inline">
                        <input class="form-check-input owner-checkbox" type="checkbox" id="owner-${owner}" value="${owner}" checked>
                        <label class="form-check-label" for="owner-${owner}">${owner}</label>
                    </div>
                `;
            });

            $('#owner-checkboxes').html(checkboxHtml);
        }

        // Handle owner filter application
        $('#apply-owner-filter').click(function() {
            const selectedOwners = [];
            $('.owner-checkbox:checked').each(function() {
                selectedOwners.push($(this).val());
            });

            const table = $('#results-table table');
            table.find('tbody tr').each(function() {
                const ownerCell = $(this).find('td:first');
                const owner = ownerCell.text().trim();
                
                if (owner === 'Total' || selectedOwners.includes(owner)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });
    </script>
</body>
</html>
